{
  "hash": "d529420047d0f623b2249dac5b97f946",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Evaluation of a pediatric Transitional Care Unit in the Netherlands\" \nsubtitle: \"Datasimulation for BRIDGE study using bayesian inverse probability weighting methods\"\nauthors:\n  - name: Heleen Haspels\n    department: Pediatric Intensive Care Unit\n    affiliation: Amsterdam UMC location University of Amsterdam, Emma Children’s Hospital & Erasmus Medical Center - Sophia Childrens hospital\n    location: Amsterdam and Rotterdam, the Netherlands\n    email: h.n.haspels@amsterdamumc.nl\n  - name: Misja Mikkers\n    department: Health Technology & Services Research\n    affiliation: University of Twente\n    location: Enschede, the Netherlands\n    email: m.c.mikkers@utwente.nl\ndescription: \"In this post, we demonstrate through data simulation how we will measure the effect of an innovative Transitional Care Unit (TCU) called the Jeroen Pit Huis (JPH). We are using bayesian probability weighting methods.\"\ndate: 03-20-2024 \ncategories: \n  - Innovative care model \n  - Bayesian probability weighting methods\n  - Datasimulation\ndraft: false\nbibliography: refs.bib\nformat:\n  html:\n    toc: true\n    code-fold: true\n    self-contained: true\n    number-sections: true\n---\n\n\n\n\n# Introduction\n\nThe [Transitional Care Unit (TCU) consortium](https://tcuconsortium.nl/) has initiated the BRIDGE study to examine the effectiveness of the [Jeroen Pit Huis](https://hetjeroenpithuis.nl/) (JPH). The JPH is a unique and innovative TCU situated in close proximity of the Amsterdam UMC. In this TCU, patients and their family reside in separate private home-like apartments as an intermediate step between hospital and home. The families can stay while practicing in, and adapting to, their new reality until they are ready to transition home. In this study, we are measuring differences in outcomes between patients discharges via the TCU JPH and patients discharged directly to home (control group). This includes patients from the Erasmus MC, Radboud umc, UMC Groningen and UMC Utrecht. Patients from the Amsterdam UMC who transition directly from hospital to home without an intermediate stay in the JPH will also be included in the control group.\n\nIn this blog, we explain how we will determine the effect of the intervention using bayesian inverse probability weighting methods. This blog only describes the analyses; the study protocol is registered at clinical trials.gov (hyperlink maken als nummer bekend is) and broader research design will be published in a scientific journal (if this is published, we will post them here)\n\nPictures of the Jeroen Pit Huis: \n<table>\n  <tr>\n    <td><img src=\"images/JPHappartement.jpg\" style=\"width:260px;height:190px;\"></td>\n    <td><img src=\"images/JPHkeuken.jpg\" style=\"width:260px;height:190px;\"></td>\n    <td><img src=\"images/JPHspeelhoek.jpg\" style=\"width:260px;height:190px;\"></td>\n  </tr>\n</table>\n\n\n<style>\np.comment {\nbackground-color: #f0ffff;\npadding: 10px;\nborder: 1px solid black;\nmargin-left: 25px;\nmargin-right: 25px;\nborder-radius: 5px;\n}\n\n</style>\n\n\n<p class=\"comment\">\n**Note:** The BRIDGE study is currently ongoing and is expected to continue until at least mid-2025. Certain decisions we have made in this logbook are based on a previous study (H2H study - manuscript in preparation). The H2H study was conducted in preparation for the BRIDGE study due to the lack of existing data on the population of children in the Netherlands who potentially could use a TCU. In this study, the same population as in the BRIDGE study was included, with the objectives of: 1) describing the demographics, clinical characteristics, and course of patients transitioning from hospital to home; and 2) identifying perceived barriers to the postponement of hospital-to-home transitions.If final results are published, we will refer here to a new post including the results. This blog aimed at providing insights into the analyses.\n</p>\n\n\n# Methodology\n\n\nIn this study, we have opted for Bayesian inverse probability weighting due to its suitability for our research objectives. In the following section, we'll delve into the rationale behind our methodological selection and elucidate its significant contribution to our analytically framework. Additionally, we will elucidate our data simulation process, detailing each step alongside the pertinent R code. We have gathered information and inspiration from diverse sources, including @huntington2021effect, @heiss2021, and @heiss2021b\n\n\n## Why Bayesian analysis?\n\n<p class=\"comment\">\n**Note**: The text below is adapted from a [previous blog](https://misjamikkersutwente.github.io/blog/Poweranalysis/#the-principles-of-bayesian-analysis). Read more about the principles of Bayesian analysis in that post.\n</p>\n\n\n\nWe utilize Bayesian analysis principles to evaluate the efficacy of the JPH. This approach is adopted due to the constrained data points available in the BRIDGE study. Unlike traditional significance tests, which focus on determining whether an effect is statistically significant by testing how likely the observed data are conditional on the null hypothesis being true, our Bayesian analysis aims to estimate the probability that the intervention actually has a specific effect given the data. Bayesian methods are particularly beneficial for relatively small sample sizes because they allow the incorporation of prior information and provide more intuitive and interpretable results. Additionally, Bayesian analysis can produce credible intervals that directly reflect the uncertainty about parameter estimates, making it a robust choice for studies with limited data.\nIn Bayesian analysis, we start by explicitly stating our expectation about the effect of the intervention. This initial belief is also known as a “prior.” Although we theoretically expect parental stress and the length of hospital stay to decrease at the intervention practices, we have not yet seen evidence of this. Therefore, we formulate our prior conservatively and assume that the intervention has no effect, with a considerable degree of uncertainty. This means we initially assume that the chance of a positive effect (lower parental stress / fewer hospital days) is as great as a negative effect (higher parental stress / more hospital days).\n\nNext, we collect data. Based on this data, we adjust our prior beliefs. The adjusted belief is expressed in the so-called ‘posterior belief’. The posterior represents the probability that the intervention has an effect, taking into account both our initial belief (the prior) and the data. In other words: the posterior is a mix of the prior and the data. As we collect more data, the influence of the prior on the value of the posterior decreases (for example, we can get more data by adding intervention and control practices, or when we switch to an analysis at the patient level).\n\nIn summary, the use of Bayesian analysis allows us to work with limited data and still obtain useful insights about the likelihood of an intervention effect. This is particularly relevant in situations where it is difficult to collect enough data points to perform traditional significance tests. By shifting the focus from mere significance to probability, we can better deal with uncertainty and variability in our results.\n\n\n## Quasi-experimental study design\n\nThis study is a quasi-experimental prospective cohort study comparing the JPH to other H2H practices. We opted for this design because conducting a Randomized Controlled Trial (RCT) was not feasible. The assignment of patients to the intervention cannot be randomized because children are assigned to a ward/JPH based on the hospital. Geographical location determines a child’s H2H program. Random assignment to specific hospitals is not feasible due to the practical difficulties and negative impact of relocating families from their usual living environment.\n\nThe question then remains: how to control confounding effects in this study? The problem is that populations between the intervention and control groups differ in characteristics and outcomes (confounding). In an RCT, study subjects are randomly assigned to exposure categories, which helps break any links between exposure and confounders. This random assignment reduces the potential for confounding. If these differences are not controlled for, the intervention effect may be underestimated or overestimated.\n\n\n<p class=\"comment\">\n**Example:** Imagine you want to measure the effect of an intervention that helps in getting a job. You want to compare a specific policy program in Rotterdam (intervention) with a existing policy program Amsterdam (control). However, in the intervention group, there are more women who already have a higher chance of getting a job than men. If we do not correct for gender, we may overestimate the intervention effect.\n</p>\n\nHowever, if an RCT is not feasible (as in our case), there are other options to estimate a causal effect. One of those methods is Difference in Differences (DiD) estimation. The idea behind a DiD is to compare the difference in outcome changes between the treatment group and the control group before and after the intervention. If the effect of the intervention is significant, this should be reflected in a larger difference in outcomes between the treatment and control groups after the implementation of the treatment, compared to before the implementation of the treatment. However, a DiD is also not feasible in our study because we do not have data available before the opening of the TCU. Therefore, we have opted for inverse probability weighting.\n\n\n## Inverse probability weigthing\n\nTo adjust for confounders we use bayesian inverse probability weighting. The following steps need to be undertaken:\n\n\n\n1.  Create a model that predicts treatment. Use confounders (identified with a Directed Acyclic Graph(DAG)) as the covariates. \nSo: Predicts for each patient the probability that the patient - given their charateristics (confounders) - is in the treatment group. For this, we use Bayesian Logistic regressions (Bernoulli distribution). We refer to this probability as 'propensity scores'.\n\n2.  Generate samples of propensity scores based on the posterior distribution of propensity scores. This will give us a lot of propensity scores.\n\n3.  Convert those propensity scores into *inverse probability of treatment weights* (IPTW) using this formula:\n\n$$\\frac{\\text{Treatment}}{\\text{Propensity score}} + \\frac{1 - \\text{Treatment}}{1 -\\text{Propensity score}}$$\n\n4.  Run an outcome model using those weights.\n\n</ol>\n\n# Datasimulation\nBelow we will elucidate our data simulation process, detailing each step alongside the pertinent R code. We use R version: 4.3.3.Ensure that the following four packages are downloaded.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load libraries (please install the packages if needed)\n\nlibrary(tidyverse) # for data manipulation and plotting\nlibrary(broom) # tidy regression output\nlibrary(ggdag) # nicer dags\nlibrary(brms) # for bayesian analysis\n```\n:::\n\n\n\n## Directed Acyclic Graph (DAG)\n\nDirected Acyclic Graphs (DAGs) are tools used to represent and analyze causal relationships in statistical models. They consist of nodes representing variables and directed edges indicating the direction of causality.DAGs help identify and control for confounding variables, making them useful for the construction of and communicating about causal models.\n\n@pearl2018book provides a popular and accessible introduction to the concepts and applications of DAGs. It illustrates how these graphs can clarify causal questions and guide effective data analysis. See @pearl2016causal for a more comprehensive and detailed treatment.\n\nOur strategy involves mapping out the confounding factors using a directed acyclic graph (DAG) and then controlling for these differences. It is crucial to our approach that our DAG is both *accurate* and *complete*.\n\nFor this simulation we use a simplified generic DAG for two outcomes. Below in the DAG we show the relationship between getting the treatment (going to the JPH) (measured as a 0/1 binary variable where 1 = person went to the JPH) and Length of hospital stay (measured in days) / parental stress (measured on a scale of 0-10, with higher values representing higher amount of stress). Both are confounded by the number of children in the family, if the index patient is de oldest child in the family, is parents are living together, and if they are dutch speaking.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create DAG\nJP_dag <- dagify(\n  LOS ~ JP + Children + Eldest_child + Living_situation + Dutch,\n  JP ~ Children + Eldest_child + Living_situation + Dutch,\n  Eldest_child ~ Children,\n  exposure = \"JP\",\n  outcome = \"LOS\",\n  coords = list(x = c(LOS = 7, JP = 3, Dutch = 4, Living_situation = 6, Children = 4, Eldest_child = 6),\n                y = c(LOS = 2, JP = 2, Dutch = 1, Living_situation = 1, Children = 3, Eldest_child = 3)),\n  labels = c(LOS = \"Outcome\\n(Length of Stay\\nor Stress)\", JP = \"Jeroen Pit Huis\", Children = \"Number of children\", \n             Eldest_child = \"Patient is eldest child\", Living_situation = \"Living situation\", \n             Dutch = \"Dutch speaking\"))\n\n# Turn DAG into a tidy data frame for plotting\nJP_dag1 <- JP_dag %>% \n  tidy_dagitty() %>%\n  node_status()   # Add column for exposure/outcome/latent\n\nstatus_colors <- c(exposure = \"#01796F\", outcome = \"#F79802\", latent = \"grey50\")\n\n# Fancier graph\nggplot(JP_dag1, aes(x = x, y = y, xend = xend, yend = yend)) +\n  geom_dag_edges() +\n  geom_dag_point(aes(color = status)) +\n  geom_label(aes(label = label, fill = status),\n             color = \"white\", fontface = \"bold\", nudge_y = -0.38, nudge_x = 0.3) +\n  scale_color_manual(values = status_colors, na.value = \"grey20\") +\n  scale_fill_manual(values = status_colors, na.value = \"grey20\") +\n  guides(color = \"none\", fill = \"none\") +\n  theme_dag()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/DAG-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(\"JP_dag.png\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSaving 7 x 5 in image\n```\n\n\n:::\n:::\n\n\n\nWe simulate a data based on our DAG and the parameters of the H2H study mentioned in the introduction. This simulation involves generating data for patients from four different hospitals (AMC, EMC, RUMC, and UMCG) with varying characteristics such as living situations, language proficiency, number of children, and eldest patient status.\n\nSpecifically, we simulate:\n\n1.  **Living Situation**: Proportions of patients living together, alone, or in other arrangements.\n\n2.  **Language Proficiency**: Likelihood of patients speaking Dutch or other languages based on their hospital.\n\n3.  **Number of Children**: Distribution of patients having different numbers of children.\n\n4.  **Length of Stay (LOS)**: Estimated hospital stay length influenced by various factors such as hospital type, number of children, language proficiency, and living situation.\n\n5.  **Stress Levels**: Patient stress levels measured on a Likert scale, accounting for similar influencing factors. To generate the Likert scale for stress levels, we used latent variables, which are underlying factors that influence observed data but are not directly measured. In our simulation, we created a latent variable for stress and added specific influences from factors like eldest patient status, language proficiency, and living situation. We then mapped this latent variable onto a Likert scale (1-10) using predefined cut-off points.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\n\n# Settings: number of patients in 4 different hospitals\nAMC <- 50  # AMC\nEMC <- 60  # EMC\nRUMC <- 40 # RUMC\nUMCG <- 15 # UMCG\n\n# Living situation proportions based on a total number of patients (Total_LS)\nTotal_LS <- 43\nTogether <- 34 / Total_LS\nAlone <- 4 / Total_LS\nOther <- 5 / Total_LS\n\n# Language proportions based on a total number of patients (Total_lang)\nTotal_lang <- 43\nDutch_AMC <- 7 / 10\nDutch_EMC <- 18 / 20\nDutch_RUMC <- 0.95\nDutch_UMCG <- 0.99\n\n# Calculate the total number of patients\nTotal_patients <- sum(AMC, EMC, RUMC, UMCG)\n\n# Effect sizes for length of stay (LOS) and stress\nEffect_LOS <- 7\nEffect_stress <- 0.2\n\n# Cut-off points for latent variable to Likert scores (1-10)\ncut_off <- c(-0.8, -0.6, 0.1, 0.5, 0.7, 0.9, 1, 1.1, 1.2)\n\n# Mean and standard deviation for normally distributed variables\nMU <- 1\nSD <- 0.1\n\n# Create the dataframe (df)\ndf <- tibble(ID = 1:Total_patients) %>%\n  mutate(Hospital = as.factor(ifelse(ID <= AMC, \"AMC\",\n                                     ifelse(ID <= AMC + EMC, \"EMC\",\n                                            ifelse(ID <= AMC + EMC + RUMC, \"RUMC\", \"UMCG\"))))) %>%\n  mutate(Treatment = as.factor(ifelse(Hospital == \"AMC\", 1, 0))) %>%\n  mutate(T_num = as.numeric(as.character(Treatment))) %>%\n  mutate(Living_situation = as.factor(sample(x = c(\"together\", \"alone\", \"other\"), replace = TRUE, \n                                             size = Total_patients, prob = c(Together, Alone, Other)))) %>%\n  mutate(Dutch_speaking = as.factor(ifelse(Hospital == \"AMC\", \n                                           sample(x = c(\"Dutch\", \"Non-Dutch\"), replace = TRUE, \n                                                  size = Total_patients, prob = c(Dutch_AMC, 1 - Dutch_AMC)), \n                                           ifelse(Hospital == \"EMC\", \n                                                  sample(x = c(\"Dutch\", \"Non-Dutch\"), \n                                                         replace = TRUE, size = Total_patients, \n                                                         prob = c(Dutch_EMC, 1 - Dutch_EMC)), \n                                                  ifelse(Hospital == \"RUMC\", \n                                                         sample(x = c(\"Dutch\", \"Non-Dutch\"),\n                                                                replace = TRUE, size = Total_patients, \n                                                                prob = c(Dutch_RUMC, 1 - Dutch_RUMC)), \n                                                         sample(x = c(\"Dutch\", \"Non-Dutch\"), \n                                                                replace = TRUE, \n                                                                size = Total_patients, prob = c(Dutch_UMCG, 1 - Dutch_UMCG))))))) %>%\n  mutate(NL = ifelse(Dutch_speaking == \"Dutch\", 0, 1)) %>%\n  mutate(Number_of_children = ifelse(Hospital == \"AMC\", sample(x = c(1, 2, 3, 4, 5), size = Total_patients, \n                                                               replace = TRUE, prob = c(0.5, 0.3, 0.1, 0.1, 0.1)),\n                                     ifelse(Hospital == \"EMC\", sample(x = c(1, 2, 3, 4, 5), size = Total_patients, \n                                                                      replace = TRUE, prob = c(0.4, 0.35, 0.15, 0.1, 0.1)),\n                                            ifelse(Hospital == \"RUMC\", sample(x = c(1, 2, 3, 4, 5), size = Total_patients, \n                                                                              replace = TRUE, prob = c(0.375, 0.5, 0.1, 0.125, 0.1)),\n                                                   sample(x = c(1, 2, 3, 4, 5), size = Total_patients, \n                                                          replace = TRUE, prob = c(0.2, 0.4, 0.2, 0.1, 0.2)))))) %>%\n  mutate(Eldest_patient = as.factor(ifelse(Number_of_children == 1, 1,\n                                           ifelse(Hospital == \"AMC\", sample(x = c(0, 1), size = Total_patients, replace = TRUE, \n                                                                            prob = c(0.3, 0.7)),\n                                                  sample(x = c(0, 1), size = Total_patients, replace = TRUE,\n                                                         prob = c(0.6, 0.4)))))) %>%\n  mutate(Influence_living_situation = ifelse(Living_situation == \"together\", 0, 5)) %>%\n  mutate(LOS0 = rnorm(n = Total_patients, \n                      mean = 50 + \n                        3 * Number_of_children +\n                        1 * NL +\n                        1 * Influence_living_situation +\n                        1 * as.numeric(Eldest_patient), sd = 2)) %>%\n  mutate(LOS = ifelse(Hospital == \"AMC\", LOS0 - Effect_LOS, LOS0)) %>%\n  mutate(Stress_latent0 = rnorm(n = Total_patients, mean = MU - 0.3 * as.numeric(as.character(Eldest_patient)) - \n                                0.3 * NL - \n                                0.3 * Influence_living_situation, sd = SD)) %>%\n  mutate(Stress_latent = ifelse(test = Hospital == \"AMC\",\n                                yes = Stress_latent0 + Effect_stress,\n                                no = Stress_latent0)) %>%\n  mutate(Stress0 = findInterval(Stress_latent0, cut_off) + 1) %>%\n  mutate(Stress = findInterval(Stress_latent, cut_off) + 1) %>%\n  mutate(Stress_fac = as.factor(Stress)) %>%\n  mutate(Treatment_effect = Stress - Stress0)\n\ndf_CF <- df %>%\n  mutate(Treatment = 0)\n\ndf_hospital <- df %>%\n  select(id = ID, Hospital)\n```\n:::\n\n\n\n\n\n## Visualization of the data (outcomes)\n\nTo better understand the distribution of our simulated data, we present histograms of the two main outcomes: length of stay (LOS) and stress levels. These visualizations help illustrate the variations and patterns within our synthetic data.\n\n### Length of Stay per hospital\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(df, aes(x = LOS, fill = Hospital)) +\n  geom_histogram(alpha = 0.5, binwidth = 3) +\n  theme_bw() +\n  labs(title = \"Length of Stay in Days per Hospital\", x = \"\", y = \"\") +\n  facet_wrap(~ Hospital) +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/graph LOS-1.png){width=672}\n:::\n:::\n\n\n\n### Stress levels per hospital\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(df, aes(x = Stress, fill = Hospital)) +\n  geom_histogram(binwidth = 1, alpha = 0.5) +\n  theme_bw() +\n  labs(title = \"Stress per Hospital\", x = \"\", y = \"\") +\n  facet_wrap(~ Hospital) +\n  scale_x_continuous(breaks = 1:10) +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/graph Stress-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Propensity scores and IPTWs\n\nBelow the code how we calculate our propensity scores and IPTWs based on the confounders in our DAG:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfullrun <- 0 # saves time\n\nif (fullrun) {\n  \n  model_prop_scores <- brm(\n    formula = Treatment ~ Number_of_children + Eldest_patient + Living_situation + Dutch_speaking,\n    family = bernoulli(),  # Logistic regression\n    data = df,\n    chains = 6, \n    cores = 6, \n    warmup = 500, \n    iter = 1500,\n    seed = 123, \n    backend = \"cmdstanr\"\n  )\n\n  saveRDS(model_prop_scores, \"model_prop_scores.RDS\")\n\n} else {\n  \n  model_prop_scores <- readRDS(\"model_prop_scores.RDS\")\n\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract posterior predicted propensity scores\npred_probs_chains <- posterior_epred(model_prop_scores)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfullrun <- 0  # saves time\n\nif(fullrun){\n\nipw_matrix <- t(pred_probs_chains) %>%\n  as_tibble(.name_repair = \"universal\") %>% \n  # Add treatment column so we can calculate weights\n  mutate(T_num = df$T_num) %>% \n  # Calculate weights\n  mutate(across(starts_with(\"...\"),\n                ~ (T_num / .x) + ((1 - T_num) / (1 - .x))\n  )) %>% \n  # Get rid of treatment column\n  select(-T_num)\n\nsaveRDS(ipw_matrix, \"ipw_matrix.RDS\")\n\n} else {\n  \nipw_matrix <- readRDS(\"ipw_matrix.RDS\")\n\n}\n\nIPTW_help <- ipw_matrix %>% \n  # Convert this matrix to a data frame\n  as_tibble() %>%\n  # Add a column for the draw number\n  mutate(draw = 1:n()) %>% \n  # Make this long so that each draw gets its own row\n  pivot_longer(-draw, names_to = \"row\", values_to = \"weights\") %>% \n  # Clean up the draw number \n  mutate(draw = as.numeric(str_remove(row, \"...\"))) %>%\n  select(-row)\n```\n:::\n\n\n\n\n## Psuedo-populations\n\nBefore running the bayesian regressions, it's helpful to understand what these weight are actually doing behind the scenes.\n\nWe can learn a few different things from the plot below. Fewer people received the treatment than didn’t—there are more people in the untreated part of the graph. \n\nThe two groups - intervention and control - aren't comparable at this point. Therefore we created two pseudo-populations of treated and untreated people.Using the IPTW scores, individual patients are weighted, with patients having a higher likelihood of treatment exposure receiving less weight and patients with a lower likelihood receiving more weight. This results in a weighted dataset in which the confounding effects are reduced.\n\n<p class=\"comment\">\n**Note:** It's challenging to visualize how we perform this using the Bayesian method because we have calculated 1500 propensity scores for each patient. To make it visualizable, we have chosen to take the mean of the propensity scores and then calculate the IPTWs based on the mean.\n</p>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# We based our graph on the means of the propensity scores and the IPTW\n# Calculate the mean propensity scores and IPTW\nmean_propensity <- colMeans(pred_probs_chains)\ndf_with_weights <- df %>%\n  mutate(propensity = mean_propensity,\n         iptw = (T_num / propensity) + ((1 - T_num) / (1 - propensity)))\n\n# Plot the graph\nggplot() +\n  geom_histogram(data = filter(df_with_weights, T_num == 1), \n                 aes(x = propensity, weight = iptw), bins = 10,\n                 fill = colorspace::lighten(\"#01796F\", 0.35)) + \n  geom_histogram(data = filter(df_with_weights, T_num == 0), \n                 aes(x = propensity, weight = iptw, y = -after_stat(count)), bins = 10,\n                 fill =  colorspace::lighten(\"#F79802\", 0.35)) +\n  geom_histogram(data = filter(df_with_weights, T_num == 1), \n                 aes(x = propensity), bins = 10,\n                 fill = \"#01796F\") + \n  geom_histogram(data = filter(df_with_weights, T_num == 0), \n                 aes(x = propensity, y = -after_stat(count)), bins = 10,\n                 fill =  \"#F79802\") +\n  geom_hline(yintercept = 0) +\n  annotate(geom = \"label\", x = 1, y = 105, label = \"Treated\", \n           fill = \"#01796F\", color = \"white\", hjust = 1) +\n  annotate(geom = \"label\", x = 1, y = -80, label = \"Untreated\", \n           fill = \"#F79802\", color = \"white\", hjust = 1) +\n  annotate(geom = \"label\", x = 1, y = -100, label = \"Untreated pseudo-population\", \n           fill = colorspace::lighten(\"#F79802\", 0.35), color = \"white\", hjust = 1) +\n  annotate(geom = \"label\", x = 1, y = 125, label = \"Treated pseudo-population\", \n           fill = colorspace::lighten(\"#01796F\", 0.35), color = \"white\", hjust = 1) +\n  scale_y_continuous(label = abs) +\n  labs(x = \"Propensity\", y = \"Count\") +\n  coord_cartesian(xlim = c(0.0, 1.05)) +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/graph psuedo populations-1.png){width=672}\n:::\n:::\n\n\n\n\n# Analysis\n\nIn this section, we analyze the simulated data to estimate the causal effects of the Jeroen Pit Huis (JPH) intervention on patient outcomes, specifically focusing on length of hospital stay (LOS) and parental stress levels. Using the calculated inverse probability weights (IPWs), we conduct Bayesian regression analyses to adjust for confounders and provide robust estimates of the treatment effect. Given that we have a sample of the posterior distribution of the IPWs and considering that the brms package cannot directly take a matrix as input for weights, we performed 1500 regressions in a loop, each time using a different vector of weights. We begin with a Gaussian regression analysis for the numeric outcome variable LOS, followed by a cumulative model for the ordinal outcome variable of stress levels. The results of these regressions are presented as plots to visualize the estimated treatment effects and the uncertainty.\n\n## Length of hospital stay regression\n\nTo evaluate the impact of the JPH intervention on the length of hospital stay (a numeric variable and measured in days), we perform a Gaussian regression analysis. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfullrun <- 0  # saves time\n\nif (fullrun) {\n  \n  Number_regressions <- 1500  # moet 1500 zijn\n\n  LDEstimate <- c()\n  LDlower_95CI <- c()\n  LDupper_95CI <- c()\n\n  LDPreds <- tibble(id = 1:165)\n  LDPreds_CF <- tibble(id = 1:165)\n\n  for (i in 1:Number_regressions) {\n    \n     # Print the current iteration\n    message(\"Running iteration: \", i)\n    \n    df_temp <- IPTW_help %>%\n      filter(draw == i)\n\n    df_temp2 <- df %>%\n      bind_cols(df_temp)\n\n    LDFormula <- LOS | weights(weights) ~ Treatment  \n\n    LDreg <- brm(\n      formula = LDFormula,  # our formula\n      data = df_temp2,  # data\n      family = gaussian(),  # model for continuous data\n      warmup = 500, \n      iter = 1500, \n      cores = 6,  # If you have 2 cores on your own computer set this to 2\n      chains = 6,\n      seed = 1729,\n      silent = TRUE,\n      backend = \"cmdstanr\"\n    )\n\n    last_row <- tail(fixef(LDreg), 1)\n\n    LDEstimate[i] <- last_row[1, 1]\n    LDlower_95CI[i] <- last_row[1, 3]\n    LDupper_95CI[i] <- last_row[1, 4]\n\n    LDResults <- tibble(LDEstimate, LDlower_95CI, LDupper_95CI) \n  }\n\n  saveRDS(LDResults, \"LDResults.RDS\")\n\n} else {\n  \n  LDResults <- readRDS(\"LDResults.RDS\")\n\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = LDResults, aes(x = LDEstimate)) +\n  geom_density(fill = \"steelblue\", alpha = 0.3) +\n  theme_bw() +\n  geom_vline(xintercept = -1 * Effect_LOS, \n             color = \"firebrick\", \n             linetype = \"dashed\",\n             linewidth = 1) +\n  labs(x = \"Estimate of the treatment coefficient\", y = \"\") +\n  annotate(geom = \"text\", x = Effect_LOS * -1 + 0.7, y = 0.5, \n           label = \"Simulated effect\",\n           color = \"firebrick\") +\n  xlim(-10, 10)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/results LOS-1.png){width=672}\n:::\n:::\n\n\n\nThe plot above shows the distribution of the estimated treatment coefficients for the length of hospital stay (LOS) outcome. The vertical dashed line represents the simulated effect of the JPH intervention on LOS. The distribution of the estimated coefficients indicates the uncertainty around the treatment effect, with the majority of the estimates slightly overstating the simulated effect.\n\n## Parental stress regression\n\nNext, we analyze the impact of the JPH intervention on parental stress levels, which are measured on an ordinal scale. We use a cumulative model to estimate the treatment effect on stress levels. The cumulative model estimates the probability that the stress level exceeds a certain threshold, given the treatment and control conditions.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNumber_regressions <- 1500  # moet 1500 zijn\nfullrun <- 0 # saves time\n\nif(fullrun){\n  \n\n\n\nEstimate <- c()\nlower_95CI <- c()\nupper_95CI <- c()\n\n\n\nfor (i in 1:Number_regressions){\n\ndf_temp <- IPTW_help %>%\n  filter(draw == i)\n\ndf_temp2 <- df %>%\n  bind_cols(df_temp)\n\nFormula <- Stress | weights(weights) ~ Treatment\n\nreg <- brm(\n  formula = Formula,   # onze formule\n  data = df_temp2,            # data\n  family = cumulative(\"probit\"), # model voor ordinal data\n  warmup = 500, \n  iter = 1500, \n  cores = 6, #If you have 2 cores on your own computer set this to 2\n  chains = 6,\n  seed = 1729,\n  silent = TRUE,\n  backend = \"cmdstanr\"\n  \n)\n\nlast_row <- tail(fixef(reg),1)\n\nEstimate[i] <- last_row[1,1]\nlower_95CI[i] = last_row[1,3]\nupper_95CI[i] = last_row[1,4]\n\nResults <- tibble(Estimate, lower_95CI, upper_95CI) \n\n}\n\n\nsaveRDS(Results, \"Results.RDS\")\n\n\n} else {\n  \nResults <- readRDS(\"Results.RDS\")\n\n}\n\nResults <- Results %>%\n  mutate(Iteration = seq_along(Estimate))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(Results, aes(x = Estimate)) +\n  geom_histogram(aes(y = after_stat(density)), binwidth = 0.05, fill = \"steelblue\", alpha = 0.7) +\n  geom_density(color = \"steelblue4\", linewidth = 1) +\n  labs(x = \"Estimate\", y = \"Density\") +\n  geom_vline(aes(\n    xintercept = round( mean(df$Stress[df$Hospital == \"AMC\"]) - mean(df$Stress[df$Hospital != \"AMC\"]),2)), \n    color = \"firebrick\", \n    linetype = \"dashed\",\n    linewidth = 1) +\n  annotate(geom = \"text\", x = round( mean(df$Stress[df$Hospital == \"AMC\"]) - mean(df$Stress[df$Hospital != \"AMC\"]),2) - 0.14, y =2, \n           label = \"Simulated effect\\nin the data\",\n           color = \"firebrick\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/results Stress-1.png){width=672}\n:::\n:::\n\n\n\nThe plot above shows the distribution of the estimated treatment coefficients for the parental stress outcome. The vertical dashed line represents the simulated effect of the JPH intervention on parental stress levels. The distribution of the estimated coefficients indicates the uncertainty around the treatment effect, with the majority of the estimates overstating the effect to some extend. \n\n\n\n# Conclusion\n\nAs this blog serves as an online appendix for our study protocol, it provides insight into the methods we will use in our evaluation of the Jeroen Pit Huis (JPH) intervention. It is important to note that this blog and analysis have been conducted without access to the actual study data.We had access to the descriptive data in the -to be submitted- H2H study. The data was simulated to mimic the actual data.\n\nOur analysis of the simulated data demonstrates the application of our chosen methods that we will use to estimate the effects of the JPH intervention on patient outcomes. For the length of hospital stay (LOS), the Bayesian Gaussian regression analysis demonstrated that the majority of the estimated treatment effects slightly overstate the simulated effect, reflecting a degree of uncertainty inherent in our estimates. The simulated effect size for LOS was 7, while the average effect size estimated from the data was approximately -6.23.\n\n\nSimilarly, the cumulative model for parental stress levels indicates an overestimation of the effect size as well. The average effect size for parental stress was approximately 0.51, compared to the effect size observed in the data, which was 0.33. The initial effect included in the simulation was 0.2. The slight overestimation observed in our model can be attributed to several factors, including sampling variability due to the small sample size and the non-linearity introduced by translating latent stress to ordinal scores.\n\nOverall, our Bayesian approach, combined with inverse probability weighting, helps us manage the challenges of a limited sample size and noisy data, where traditional significance testing might be less effective.\n\n\n# References\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}